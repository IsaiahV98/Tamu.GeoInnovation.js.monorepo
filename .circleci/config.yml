version: 2.1
jobs:
  build:
    docker:
      - image: circleci/node:10.16
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: npm install
      - run:
          name: Build AggieMap
          command: npm run build -- --project=aggiemap --prod
      - run:
          name: Build Trees
          command: npm run build -- --project=angular-aggiemap-trees --prod
      - run:
          name: Run Tests
          command: npm run test -- -w 1 --coverage --coverageReporters=text-lcov | ./node_modules/coveralls/bin/coveralls.js
      - run:
          name: Run TSLint
          command: npm run lint
      - run:
          name: Run Prettier
          command: npx prettier **/*.ts --check
  deploy:
    machine:
      enabled: true
    steps:
      - run:
          name: Generate Artifact
          command: |
            cd dist/apps
            zip -r /tmp/aggiemap-dist.zip aggiemap
      - store_artifacts:
          path: /tmp/aggiemap-dist.zip
      - run:
          name: Deploy Dev Build
          command: curl https://dev.aggiemap.tamue.edu/deploy/deploy.aspx?build_number=$CIRCLE_BUILD_NUM
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
