<div class="column8">
  <ng-container *ngIf="!(localIdentity | async)?.email; else hasIdentity">
    <p>Email registration required to claim a county. <a [routerLink]="['../profile']">Register your email to proceed.</a></p>
  </ng-container>

  <ng-template #hasIdentity>
    <ng-container *ngIf="(localCounty | async)?.countyFips; else hasClaim">
      <p>Your active county claim is detailed below. While your claim is active, only you can submit information for this county.</p>
    </ng-container>

    <ng-template #hasClaim>
      <p>Select the state and county to set or change a claim.</p>
    </ng-template>

    <form [formGroup]="form" (ngSubmit)="submitCountyOwnership()">
      <div class="form-section">
        <div class="form-section-toolbar">
          <div class="form-section-name">County Claim</div>
        </div>

        <div class="form-section-body">
          <div class="form-collection row pad-top">
            <tamu-gisc-select formControlName="state" [data]="states | async" placeholder="Select State" [valueTemplate]="'stateFips'" [displayTemplate]="'name'" [disabled]="(localCounty | async)?.countyFips"></tamu-gisc-select>
            <tamu-gisc-select formControlName="county" [data]="counties | async" placeholder="Select County" [valueTemplate]="'countyFips'" [displayTemplate]="'name'" [disabled]="(localCounty | async)?.countyFips"></tamu-gisc-select>
          </div>
        </div>
      </div>

      <div *ngIf="!(countyClaimable | async) && (countyClaims | async)?.length > 0 && (this.form.controls.county.valueChanges | async) !== 'undefined' && (this.form.controls.state.valueChanges | async) !== 'undefined'" class="form-section">
        <div class="form-section-body">
          <div class="inform-context alert">
            <p>This county has been claimed by another user. Please choose another county.</p>
          </div>
        </div>
      </div>

      <!-- Only show phone numbers input field if there is a local county stored AND if the form countyFips value is the same as the local value -->
      <ng-container *ngIf="(localCounty | async)?.countyFips && ((localCounty | async)?.countyFips === (this.form.controls.county.value)) && ((localCounty | async)?.stateFips === (this.form.controls.state.value)) && (localCounty | async)?.countyFips !== null && (localCounty | async)?.stateFips !== null && ((this.form.controls.county.value) !== 'undefined' && (this.form.controls.state.value) !== 'undefined')">
        <div class="form-section">
          <div class="form-section-toolbar">
            <div class="form-section-name">Phone Numbers</div>
            <div class="form-section-actions">
              <span class="material-icons action alt" (click)="addPhoneNumber()" title="Add phone number">add</span>
            </div>
          </div>

          <div *ngIf="form.get('phoneNumbers')['controls'].length > 0; else promptAddPhoneNumber" [formArrayName]="'phoneNumbers'" class="form-section-body">
            <ng-container *ngFor="let ph of form.get('phoneNumbers')['controls']; let i = index">
              <div [formGroupName]="i" class="form-collection row flex align-center select-collection" [ngClass]="{'pad-top': i === 0}">
                <ng-container formGroupName="value">
                  <tamu-gisc-textbox formControlName="value" type="tel" placeholder="Phone Number" floatLabel="true"></tamu-gisc-textbox>
                  <tamu-gisc-select formControlName="type" [data]="(phoneTypes | async)?.types" displayTemplate="name" valueTemplate="guid" placeholder="Select phone type"></tamu-gisc-select>
                </ng-container>
                <span class="material-icons action error" title="Remove phone number" (click)="removeFormArrayControl('phoneNumbers', i)">close</span>
              </div>
            </ng-container>
          </div>

          <ng-template #promptAddPhoneNumber>
            <p>There are no phone numbers registered for this county.</p>
          </ng-template>
        </div>

        <div class="form-section">
          <div class="form-section-toolbar">
            <div class="form-section-name">Websites and Documents</div>
            <div class="form-section-actions">
              <span class="material-icons action alt" (click)="addWebsite()" title="Add website">add</span>
            </div>
          </div>

          <div *ngIf="form.get('websites')['controls'].length > 0; else promptAddWebsite" [formArrayName]="'websites'" class="form-section-body">
            <ng-container *ngFor="let wb of form.get('websites')['controls']; let i = index">
              <div [formGroupName]="i" class="form-collection row flex align-center select-collection" [ngClass]="{'pad-top': i === 0}">
                <ng-container formGroupName="value">
                  <tamu-gisc-textbox formControlName="value" type="text" placeholder="URL" floatLabel="true"></tamu-gisc-textbox>
                  <tamu-gisc-select formControlName="type" [data]="(websiteTypes | async)?.types" displayTemplate="name" valueTemplate="guid" placeholder="Select website type"></tamu-gisc-select>
                  <span class="material-icons action error" title="Remove URL" (click)="removeFormArrayControl('websites', i)">close</span>
                </ng-container>
              </div>
            </ng-container>
          </div>

          <ng-template #promptAddWebsite>
            <p>There are no websites registered for this county.</p>
          </ng-template>
        </div>
      </ng-container>

      <div class="form-section">
        <div class="form-section-body">
          <div class="form-collection row">
            <div class="button-row flex flex-row justify-end">
              <tamu-gisc-button look="danger" fit="relaxed" value="Close Claim" (click)="submitCloseClaim()" *ngIf="(localCounty | async)?.countyFips"></tamu-gisc-button>

              <tamu-gisc-button
                [value]="(localCounty | async)?.countyFips ? 'Update' : 'Claim'"
                type="submit"
                [look]="(localCounty | async)?.countyFips ? 'secondary': ''"
                [disabled]="form.invalid
          || !(countyClaimable | async) 
          || (this.form.controls.county.value) === 'undefined' || (this.form.controls.state.value) === 'undefined'"
              ></tamu-gisc-button>

              <tamu-gisc-button value="Proceed to Lockdown" [routerLink]="['../lockdown']" *ngIf="(localCounty | async)?.countyFips"></tamu-gisc-button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </ng-template>
</div>
